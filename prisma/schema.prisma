// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

// ============================================
// User & Authentication
// ============================================

enum UserRole {
    owner
    manager
    customer
}

model User {
    id            String    @id @default(cuid())
    email         String    @unique
    emailVerified DateTime?
    name          String
    password      String? // Hashed password
    image         String?
    bio           String?
    role          UserRole  @default(customer)

    // Relations
    accounts      Account[]
    sessions      Session[]
    enrollments   Enrollment[]
    reviews       Review[]
    orders        Order[]
    progress      LessonProgress[]
    certificates  Certificate[]
    notifications Notification[]
    wishlist      Wishlist[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([email])
    @@index([role])
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@index([userId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// ============================================
// Courses & Content
// ============================================

enum CourseLevel {
    beginner
    intermediate
    advanced
    all_levels
}

model Category {
    id          String  @id @default(cuid())
    name        String
    slug        String  @unique
    description String?
    icon        String?

    courses Course[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([slug])
}

model Course {
    id               String  @id @default(cuid())
    title            String
    slug             String  @unique
    description      String  @db.Text
    shortDescription String
    thumbnail        String?
    previewVideo     String? // Free preview video URL

    price         Decimal  @db.Decimal(10, 2)
    discountPrice Decimal? @db.Decimal(10, 2)

    level      CourseLevel @default(beginner)
    instructor String // Instructor name

    // Computed/cached fields (update via triggers or on save)
    duration      Int   @default(0) // Total duration in minutes
    lessonsCount  Int   @default(0)
    studentsCount Int   @default(0)
    rating        Float @default(0)
    reviewsCount  Int   @default(0)

    isPublished Boolean @default(false)
    isFeatured  Boolean @default(false)

    // Relations
    categoryId   String
    category     Category      @relation(fields: [categoryId], references: [id])
    sections     Section[]
    enrollments  Enrollment[]
    reviews      Review[]
    orders       Order[]
    certificates Certificate[]
    wishlist     Wishlist[]

    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    publishedAt DateTime?

    @@index([slug])
    @@index([categoryId])
    @@index([isPublished, isFeatured])
}

model Section {
    id    String @id @default(cuid())
    title String
    order Int

    courseId String
    course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
    lessons  Lesson[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([courseId, order])
    @@index([courseId])
}

// ============================================
// Lesson Types Enum
// ============================================

enum LessonType {
    video // üé• Video Lesson - Recorded lectures, screencasts
    text // üìù Text/Article - Written explanations, markdown
    quiz // ‚ùì Quiz/Test - Multiple choice, true/false, etc.
    assignment // üìÇ Assignment/Homework - File upload, text submission
    coding // üíª Coding Exercise - In-browser editor, auto-grading
    project // üß™ Project/Case Study - Real-world multi-step task
    task // üéØ Task/Challenge - Simple "do and mark complete"
    exam // üìä Exam/Final Test - Combination quiz, passing score required
    milestone // üèÅ Milestone/Checkpoint - Progress gate
    discussion // üí¨ Discussion/Q&A - Lesson-specific comments
    announcement // üì¢ Announcement - Instructor messages
    survey // üß† Reflection/Survey - Feedback forms
    resource // üìé Downloadable Resource - PDFs, code, slides
    external // üîó External Resource - YouTube, GitHub, docs
    live // üì∫ Live Lesson - Zoom/Meet integration
    group_work // ü§ù Group Work - Team assignments, peer review
    certificate // üèÜ Certificate Lesson - Issued after completion
}

model Lesson {
    id          String     @id @default(cuid())
    title       String
    description String?    @db.Text
    type        LessonType @default(video)
    order       Int
    isFree      Boolean    @default(false) // Free preview lesson
    duration    Int        @default(0) // Estimated duration in seconds

    // Content based on type (polymorphic content)
    // For video type
    videoUrl       String? // Secure video URL
    videoThumbnail String?
    subtitlesUrl   String? // VTT subtitles file

    // For text type
    content String? @db.Text // Markdown/rich text content

    // For quiz/exam type
    passingScore   Int?     @default(70) // Percentage required to pass
    timeLimit      Int? // Time limit in minutes (null = unlimited)
    shuffleOptions Boolean? @default(false)
    showAnswers    Boolean? @default(true) // Show correct answers after

    // For assignment type
    instructions         String?   @db.Text
    allowFileUpload      Boolean?  @default(true)
    allowTextSubmission  Boolean?  @default(true)
    allowedFileTypes     String? // Comma-separated: pdf,zip,jpg
    maxFileSize          Int? // Max file size in MB
    dueDate              DateTime?
    requiresManualReview Boolean?  @default(true)

    // For coding type
    starterCode      String? @db.Text
    solutionCode     String? @db.Text
    language         String? // python, javascript, html, etc.
    testCases        String? @db.Text // JSON array of test cases
    allowedLanguages String? // Comma-separated languages

    // For external/live type
    externalUrl  String? // YouTube, GitHub, Zoom link
    externalType String? // youtube, github, zoom, meet, custom
    scheduledAt  DateTime? // For live lessons
    recordingUrl String? // Recording after live session

    // For milestone type
    requiredLessons String? // JSON array of lesson IDs that must be completed

    // For discussion type
    allowComments Boolean? @default(true)

    // Relations
    sectionId   String
    section     Section            @relation(fields: [sectionId], references: [id], onDelete: Cascade)
    resources   Resource[]
    progress    LessonProgress[]
    questions   QuizQuestion[]
    submissions LessonSubmission[]
    comments    LessonComment[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([sectionId, order])
    @@index([sectionId])
    @@index([type])
}

// ============================================
// Quiz Questions & Options
// ============================================

enum QuestionType {
    multiple_choice // Single correct answer
    multi_select // Multiple correct answers
    true_false
    fill_blank // Fill in the blank
    matching // Match pairs
    short_answer // Text answer
    code // Code answer
}

model QuizQuestion {
    id          String       @id @default(cuid())
    lessonId    String
    lesson      Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
    type        QuestionType @default(multiple_choice)
    question    String       @db.Text
    explanation String?      @db.Text // Explanation shown after answering
    points      Int          @default(1)
    order       Int

    options QuizOption[]
    answers QuizAnswer[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([lessonId, order])
    @@index([lessonId])
}

model QuizOption {
    id         String       @id @default(cuid())
    questionId String
    question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
    text       String       @db.Text
    isCorrect  Boolean      @default(false)
    order      Int

    // For matching questions - what this option matches to
    matchesTo String?

    @@unique([questionId, order])
    @@index([questionId])
}

model QuizAnswer {
    id         String       @id @default(cuid())
    questionId String
    question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
    userId     String
    answer     String       @db.Text // JSON for complex answers
    isCorrect  Boolean
    points     Int          @default(0) // Points earned

    createdAt DateTime @default(now())

    @@unique([questionId, userId])
    @@index([questionId])
    @@index([userId])
}

// ============================================
// Lesson Submissions (Assignments, Coding, Projects)
// ============================================

enum SubmissionStatus {
    draft
    submitted
    under_review
    graded
    returned // Returned for revision
}

model LessonSubmission {
    id       String           @id @default(cuid())
    lessonId String
    lesson   Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
    userId   String
    status   SubmissionStatus @default(draft)

    // Content
    textContent String? @db.Text // Text submission
    codeContent String? @db.Text // Code submission
    fileUrls    String? @db.Text // JSON array of file URLs

    // Code execution results
    codeOutput  String? @db.Text
    testResults String? @db.Text // JSON with test results
    passedTests Int?
    totalTests  Int?

    // Grading
    score    Int? // Score out of 100
    feedback String?   @db.Text // Instructor feedback
    gradedBy String? // User ID of grader
    gradedAt DateTime?

    submittedAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    @@unique([lessonId, userId])
    @@index([lessonId])
    @@index([userId])
    @@index([status])
}

// ============================================
// Lesson Comments (Discussion)
// ============================================

model LessonComment {
    id       String @id @default(cuid())
    lessonId String
    lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
    userId   String
    content  String @db.Text

    // For threaded comments
    parentId String?
    parent   LessonComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
    replies  LessonComment[] @relation("CommentReplies")

    isPinned     Boolean @default(false)
    isInstructor Boolean @default(false) // Posted by instructor

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([lessonId])
    @@index([userId])
    @@index([parentId])
}

// ============================================
// Resources (Downloadable files)
// ============================================

enum ResourceType {
    pdf
    code
    slides
    cheatsheet
    source_code
    link
    file
}

model Resource {
    id    String       @id @default(cuid())
    title String
    type  ResourceType
    url   String

    lessonId String
    lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([lessonId])
}

// ============================================
// Enrollment & Progress
// ============================================

model Enrollment {
    id String @id @default(cuid())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    progress Float @default(0) // Percentage 0-100

    enrolledAt   DateTime  @default(now())
    completedAt  DateTime?
    lastAccessAt DateTime  @default(now())

    @@unique([userId, courseId])
    @@index([userId])
    @@index([courseId])
}

model LessonProgress {
    id String @id @default(cuid())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    lessonId String
    lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

    // For video lessons
    watchedSeconds Int @default(0) // How many seconds watched

    // For quiz/exam lessons
    quizScore    Int? // Score achieved (percentage)
    quizAttempts Int       @default(0)
    lastQuizDate DateTime?

    // For coding lessons
    codePassed Boolean? // All tests passed
    codeScore  Int? // Score percentage

    // General completion
    isCompleted Boolean   @default(false)
    completedAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, lessonId])
    @@index([userId])
    @@index([lessonId])
}

// ============================================
// Reviews
// ============================================

model Review {
    id      String @id @default(cuid())
    rating  Int // 1-5
    comment String @db.Text

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    isApproved Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, courseId]) // One review per user per course
    @@index([courseId])
    @@index([userId])
}

// ============================================
// Orders & Payments
// ============================================

enum OrderStatus {
    pending
    completed
    failed
    refunded
}

model Order {
    id          String @id @default(cuid())
    orderNumber String @unique

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id])

    amount   Decimal     @db.Decimal(10, 2)
    currency String      @default("USD")
    status   OrderStatus @default(pending)

    paymentMethod String?
    paymentId     String? // External payment provider ID

    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    completedAt DateTime?

    @@index([userId])
    @@index([courseId])
    @@index([orderNumber])
    @@index([status])
}

// ============================================
// Certificates
// ============================================

model Certificate {
    id            String @id @default(cuid())
    certificateId String @unique // Public certificate ID for verification

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id])

    issuedAt DateTime @default(now())

    @@unique([userId, courseId])
    @@index([certificateId])
    @@index([userId])
}

// ============================================
// Notifications
// ============================================

enum NotificationType {
    enrollment
    order
    review
    certificate
    info
}

model Notification {
    id      String           @id @default(cuid())
    type    NotificationType
    title   String
    message String
    read    Boolean          @default(false)

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([userId])
    @@index([read])
}

// ============================================
// Wishlist
// ============================================

model Wishlist {
    id String @id @default(cuid())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@unique([userId, courseId])
    @@index([userId])
    @@index([courseId])
}
