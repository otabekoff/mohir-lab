// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

// ============================================
// User & Authentication
// ============================================

enum UserRole {
    owner
    manager
    customer
}

model User {
    id            String    @id @default(cuid())
    email         String    @unique
    emailVerified DateTime?
    name          String
    password      String? // Hashed password
    image         String?
    bio           String?
    role          UserRole  @default(customer)

    // Relations
    accounts      Account[]
    sessions      Session[]
    enrollments   Enrollment[]
    reviews       Review[]
    orders        Order[]
    progress      LessonProgress[]
    certificates  Certificate[]
    notifications Notification[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([email])
    @@index([role])
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@index([userId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// ============================================
// Courses & Content
// ============================================

enum CourseLevel {
    beginner
    intermediate
    advanced
    all_levels
}

model Category {
    id          String  @id @default(cuid())
    name        String
    slug        String  @unique
    description String?
    icon        String?

    courses Course[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([slug])
}

model Course {
    id               String  @id @default(cuid())
    title            String
    slug             String  @unique
    description      String  @db.Text
    shortDescription String
    thumbnail        String?
    previewVideo     String? // Free preview video URL

    price         Decimal  @db.Decimal(10, 2)
    discountPrice Decimal? @db.Decimal(10, 2)

    level      CourseLevel @default(beginner)
    instructor String // Instructor name

    // Computed/cached fields (update via triggers or on save)
    duration      Int   @default(0) // Total duration in minutes
    lessonsCount  Int   @default(0)
    studentsCount Int   @default(0)
    rating        Float @default(0)
    reviewsCount  Int   @default(0)

    isPublished Boolean @default(false)
    isFeatured  Boolean @default(false)

    // Relations
    categoryId   String
    category     Category      @relation(fields: [categoryId], references: [id])
    sections     Section[]
    enrollments  Enrollment[]
    reviews      Review[]
    orders       Order[]
    certificates Certificate[]

    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    publishedAt DateTime?

    @@index([slug])
    @@index([categoryId])
    @@index([isPublished, isFeatured])
}

model Section {
    id    String @id @default(cuid())
    title String
    order Int

    courseId String
    course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
    lessons  Lesson[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([courseId, order])
    @@index([courseId])
}

model Lesson {
    id          String  @id @default(cuid())
    title       String
    description String? @db.Text
    videoUrl    String // Secure video URL (stored encrypted or with signed access)
    duration    Int     @default(0) // Duration in seconds
    order       Int
    isFree      Boolean @default(false) // Free preview lesson

    sectionId String
    section   Section          @relation(fields: [sectionId], references: [id], onDelete: Cascade)
    resources Resource[]
    progress  LessonProgress[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([sectionId, order])
    @@index([sectionId])
}

enum ResourceType {
    pdf
    code
    link
    file
}

model Resource {
    id    String       @id @default(cuid())
    title String
    type  ResourceType
    url   String

    lessonId String
    lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([lessonId])
}

// ============================================
// Enrollment & Progress
// ============================================

model Enrollment {
    id String @id @default(cuid())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    progress Float @default(0) // Percentage 0-100

    enrolledAt   DateTime  @default(now())
    completedAt  DateTime?
    lastAccessAt DateTime  @default(now())

    @@unique([userId, courseId])
    @@index([userId])
    @@index([courseId])
}

model LessonProgress {
    id String @id @default(cuid())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    lessonId String
    lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

    watchedSeconds Int       @default(0) // How many seconds watched
    isCompleted    Boolean   @default(false)
    completedAt    DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, lessonId])
    @@index([userId])
    @@index([lessonId])
}

// ============================================
// Reviews
// ============================================

model Review {
    id      String @id @default(cuid())
    rating  Int // 1-5
    comment String @db.Text

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

    isApproved Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, courseId]) // One review per user per course
    @@index([courseId])
    @@index([userId])
}

// ============================================
// Orders & Payments
// ============================================

enum OrderStatus {
    pending
    completed
    failed
    refunded
}

model Order {
    id          String @id @default(cuid())
    orderNumber String @unique

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id])

    amount   Decimal     @db.Decimal(10, 2)
    currency String      @default("USD")
    status   OrderStatus @default(pending)

    paymentMethod String?
    paymentId     String? // External payment provider ID

    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    completedAt DateTime?

    @@index([userId])
    @@index([courseId])
    @@index([orderNumber])
    @@index([status])
}

// ============================================
// Certificates
// ============================================

model Certificate {
    id            String @id @default(cuid())
    certificateId String @unique // Public certificate ID for verification

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id])

    issuedAt DateTime @default(now())

    @@unique([userId, courseId])
    @@index([certificateId])
    @@index([userId])
}

// ============================================
// Notifications
// ============================================

enum NotificationType {
    enrollment
    order
    review
    certificate
    info
}

model Notification {
    id      String           @id @default(cuid())
    type    NotificationType
    title   String
    message String
    read    Boolean          @default(false)

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([userId])
    @@index([read])
}
